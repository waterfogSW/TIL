# 데드락의 탐지와 해결방법

## 정의

- 두 개 이상의 프로세스나 스레드가 서로 자원을 얻지 못해 다음 처리를 하지 못하는 상태
- 무한히 다음 자원을 기다리게 되는 상태를 말한다

## 식사하는 철학자

- 다익스트라가 운영체제의 교착상태(Deadlock)을 설명하기 위해 낸 문제
- 5명의 철학자가 원탁에 앉아서 식사를 한다
    - 왼쪽 포크가 사용가능할때 까지 대기한다. 사용가능하다면 집어든다.
    - 오른쪽 포크가 사용가능할때 까지 대기한다. 사용가능하다면 집어든다
    - 양쪽의 포크를 잡으면 일정 시간만큼 식사를 한다.
    - 오른쪽 포크를 내려놓는다.
    - 왼쪽 포크를 내려놓는다.
    - 다시 1번으로 돌아간다
- 모든 철학자가 왼쪽의 포크를 집어든 상태에서 오른쪽 포크가 사용가능할때 까지 무한히 대기하는 상황이 연출 된다.

## 교착상태의 발생 조건

- 상호배제
    - 한 프로세스가 자원을 점유하고 있을때 다른 프로세스가 해당 자원을 점유하지 못하는 것.
    - 다른 프로세스도 자원을 점유하게 만들면 경쟁상태가 발생하여 자료의 일관성을 해치는 결과를 낳게 된다.
- 점유대기
    - 프로세스가 자원을 점유하고 있는 상태에서 다른 자원을 기다린다.
    - 프로세스가 필요한 모든 자원을 한번에 요청하게 하여 프로세스 대기를 없앨 수 있지만, 자원분배의 효율성이 떨어지며 기아상태가 발생할 수 있다. 또한 자원을 요구할때 자원을 반납하고 요구한 자원을 사용하기 위해 기다리게 하면 자원에 대한 내요을 저장하고 복원하기 위한 비용이 발생하기 때문에 비효율적이다.
- 비선점
    - 프로세스는 해당 자원을 사용하는 프로세스가 자원을 자발적으로 반환할 때까지 기다린다.
    - 만약 선점을 가능하게 할 경우 기아상태가 발생할 수 있으며, 작업의 진행상태를 저장하지 않는 자원의 경우 적용이 어렵다.
- 순환대기
    - 프로세스의 자원 점유 및 점유된 자원의 요구관계가 원형을 이루며 대기한다.
    - 자원의 유형에 따라 순서를 매겨 모든 자원에 우선순위를 부여하게 되면 복잡해지고, 새로운 자원이 유입되면 우선순위를 부여해야하는 번거로움이 생긴다.

## 교착 상태의 해결 방법

### 예방

- 교착 상태 발생조건중 하나를 제거하여 교착상태를 예방.
- 시스템 처리량이나 자원 사용의 효율성을 떨어트릴 수 있다.

### 회피

- 데드락 발생 가능성을 지속적으로 검사해서 데드락 발생 가능성을 회피하는 방식.
- 프로세스가 사용할 자원에 대한 부가적인 정보를 미리 제공할 것을 요구한다.
- 은행원 알고리즘
    - 요청 이후가 Safe State이면 자원에 대한 요청을 수락한다
    - Safe State(안전 상태) : 시스템이 교착상태를 일으키지 않으며, 각 프로세스가 요구한 최대 요구량 만큼 자원을 할당할 수 있는 상태. 안전순서열 존재
    - Unsafe State(불안전 상태) : 안전순서열이 존재하지 않는 상태, 교착상태의 필요조건으로 **무조건 교착상태가 발생하는 것은 아니다.**
    - 은행원 알고리즘은 해당 프로세스가 시작할때 프로세스가 가져야할 자원의 최대 개수를 미리 알아야 하기 때문에 실제 돌아가는 프로그램에 적용하기 어렵다.

### 탐지

- 대기 그래프
    - 자원 할당 그래프에서 자원을 제거한 후 간선들을 결합하여 사이클이 발생하면 교착상태를 의미한다.
- 탐지 알고리즘의 실행 시점
    - 교착 상태가 자주 발생할수록 자주 실행시켜야 한다.
    - 자원요청할 때마다 탐지 알고리즘을 호출하면 성능저하가 발생한다.
    - 지정된 시간간격으로 돌리거나 CPU사용률을 기준으로 돌린다.

### 회복

- 교착상태가 발생한 이후 문제를 해결하는 방법
    - 교착상태의 프로세스를 종료한다. (모두 종료하거나, 하나씩 종료해가며 해결)
    - 교착상태의 프로세
